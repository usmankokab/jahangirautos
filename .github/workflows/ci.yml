name: Development CI

on:
  push:
    branches: [ develop, feature/* ]
  pull_request:
    branches: [ develop, master ]

env:
  PHP_VERSION: '8.1'

jobs:
  test:
    runs-on: ubuntu-latest
    name: Test PHP Application
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ALLOW_EMPTY_PASSWORD: true
          MYSQL_DATABASE: test_installment_db
        ports:
          - 3306/tcp
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
        tools: composer:v2
        extensions: mysqli, pdo_mysql

    - name: Cache Composer
      id: composer-cache
      uses: actions/cache@v3
      with:
        path: vendor
        key: ${{ runner.os }}-php-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-php-

    - name: Install dependencies
      if: steps.composer-cache.outputs.cache-hit != 'true'
      run: composer install --no-progress --prefer-dist --optimize-autoloader

    - name: Wait for MySQL
      run: |
        until mysqladmin ping -h"127.0.0.1" --silent; do sleep 1; done

    - name: Setup test database
      run: |
        # Create test database structure
        if [ -f "database/schema.sql" ]; then
          mysql -h127.0.0.1 -P3306 test_installment_db < database/schema.sql
        fi

    - name: Run PHP syntax check
      run: |
        find . -name "*.php" -not -path "./vendor/*" -exec php -l {} \;

    - name: Security scan
      run: |
        # Basic security checks
        echo "Scanning for potential security issues..."
        grep -r "eval(" . --include="*.php" --exclude-dir=vendor || echo "No eval() found"
        grep -r "\$_GET\|$_POST\|$_REQUEST" . --include="*.php" --exclude-dir=vendor | head -10 || echo "Input validation check completed"

    - name: Code quality check
      run: |
        # Install PHP_CodeSniffer if not present
        if ! composer global show squizlabs/php_codesniffer; then
          composer global require squizlabs/php_codesniffer --quiet
        fi
        
        # Basic code style check (you can customize this)
        ~/.composer/vendor/bin/phpcs --version || echo "PHPCS not available, skipping"

    - name: Functional tests
      run: |
        echo "Running basic functional tests..."
        # You can add PHPUnit tests here if you have them
        
        # Test basic database connectivity
        php -r "
          \$servername = '127.0.0.1';
          \$username = 'root';
          \$password = '';
          \$dbname = 'test_installment_db';
          
          \$conn = new mysqli(\$servername, \$username, \$password, \$dbname);
          if (\$conn->connect_error) {
              die('Connection failed: ' . \$conn->connect_error);
          }
          echo 'Database connection successful';
          \$conn->close();
        " || echo "Database test failed"

  code-coverage:
    runs-on: ubuntu-latest
    name: Code Coverage
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ env.PHP_VERSION }}
        tools: composer:v2
        extensions: xdebug

    - name: Install dependencies
      run: composer install --no-progress --prefer-dist

    - name: Generate coverage report
      run: |
        echo "Code coverage analysis would go here"
        echo "Note: Requires PHPUnit and Xdebug for full coverage reports"

    - name: Upload coverage reports
      if: always()
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella